name: Update websites

# Update Hugo modules and trigger deployment on dependent website repositories.
# When hugo-claris is pushed to main or stage, this workflow updates the module
# version in each dependent website and pushes the change, triggering their
# deployment pipelines.

on:
  push:
  pull_request:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  update-website:
    runs-on: ubuntu-latest

    # Prevent race conditions when multiple pushes happen quickly.
    # Each repo+branch combination gets its own queue; newer runs cancel older ones.
    concurrency:
      group: update-${{ matrix.website.repo }}-${{ github.ref_name }}
      cancel-in-progress: true

    # Process all websites even if one fails
    strategy:
      fail-fast: false
      matrix:
        # Add new dependent websites here. Each entry only needs the repo name.
        website:
          - repo: simonheimlicher/hugo-claris-demo
          - repo: simonheimlicher/heimlicher.com

    permissions:
      contents: read

    env:
      HUGO_VERSION: ${{ vars.HUGO_VERSION || '0.153.3' }}
      BRANCH_NAME: ${{ github.ref_name }}
      # Git author info derived from the actor who triggered the workflow
      EVENT_ACTOR_ID: "${{ github.actor }}"
      EVENT_ACTOR_EMAIL: "${{ github.event.sender.id }}+${{ github.event.sender.login }}@users.noreply.github.com"
      COMMIT_MESSAGE_PREFIX: "chore: update ${{ github.repository }}@${{ github.ref_name }}\n\n"

    steps:
      # ─────────────────────────────────────────────────────────────────────────
      # Setup: Install tools and checkout source repo
      # ─────────────────────────────────────────────────────────────────────────

      - name: Setup Hugo
        # Direct download from Hugo releases (no third-party action needed)
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          # Cache will be configured after website checkout (needs go.sum)
          cache: false

      # Checkout this repo (hugo-claris) to read the commit message
      - name: Checkout hugo-claris
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          path: hugo-claris

      # Save the commit message to include in the downstream commit
      - name: Save commit message
        run: |
          cd hugo-claris
          echo "${{ env.COMMIT_MESSAGE_PREFIX }}$(git log -1 --pretty=%B)" > ${{ runner.temp }}/commit_message.txt

      # ─────────────────────────────────────────────────────────────────────────
      # Check if target branch exists in the website repo
      # ─────────────────────────────────────────────────────────────────────────

      - name: Check if branch exists in ${{ matrix.website.repo }}
        id: check-branch
        run: |
          if gh api repos/${{ matrix.website.repo }}/branches/${{ env.BRANCH_NAME }} --silent 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Branch '${{ env.BRANCH_NAME }}' does not exist in ${{ matrix.website.repo }}, skipping"
            echo "### Skipped ${{ matrix.website.repo }}" >> $GITHUB_STEP_SUMMARY
            echo "Branch \`${{ env.BRANCH_NAME }}\` does not exist" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_ACTIONS_PAT }}

      # ─────────────────────────────────────────────────────────────────────────
      # Checkout and update the website repo
      # ─────────────────────────────────────────────────────────────────────────

      - name: Checkout ${{ matrix.website.repo }}
        if: steps.check-branch.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.website.repo }}
          ref: ${{ env.BRANCH_NAME }}
          token: ${{ secrets.GH_ACTIONS_PAT }}
          path: website

      # Configure Go module cache after checkout (needs go.sum from website)
      - name: Configure Go cache
        if: steps.check-branch.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('website/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Update Hugo modules in ${{ matrix.website.repo }}
        if: steps.check-branch.outputs.exists == 'true'
        run: |
          cd website

          # Update go.mod to reference the current branch of hugo-claris
          sed --in-place -Ee 's!(github.com/simonheimlicher/hugo-claris) [^ ]+(.*)!\1 '"${{ env.BRANCH_NAME }}"'\2!' go.mod

          # Fetch latest module versions and clean up go.mod/go.sum
          hugo mod get -u
          hugo mod tidy

          # Configure git for the commit
          git config user.name "${{ env.EVENT_ACTOR_ID }}"
          git config user.email "${{ env.EVENT_ACTOR_EMAIL }}"

          # Stage all changes
          git add .

          # Only commit and push if there are actual changes
          if ! git diff-index --quiet HEAD; then
            git commit --file=${{ runner.temp }}/commit_message.txt
            git push

            # Add success message to job summary
            echo "### Updated ${{ matrix.website.repo }}" >> $GITHUB_STEP_SUMMARY
            echo "Pushed module update to \`${{ env.BRANCH_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          else
            # No changes needed
            echo "### No changes for ${{ matrix.website.repo }}" >> $GITHUB_STEP_SUMMARY
            echo "Module versions already up to date on \`${{ env.BRANCH_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          fi
