{{ $scriptBundles := dict }}
{{ $page := .Page }}
{{ $template := "claris/_functions/script-bundles" }}
{{ $debug := and false ($page.Param "clarisdebug") }}
{{ $dbg := printf "%s[%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) (replaceRE `.*?([^/]+)$` `$1` $template) }}

{{ $assetVariant := .AssetVariant }}

{{ $mediaTypeList := $assetVariant.MediaTypeList }}
{{ $contentTypeList := $assetVariant.ContentTypeList }}
{{ $contentTypeListID := $assetVariant.ContentTypeListID }}

{{ $targets := (slice
  (dict
    "Target" "head"
    "Media" "all"
  )
  (dict
    "Target" "body"
    "Media" "all"
  )
) }}

{{ $priorities := (slice
  (dict
    "Match" "base"
    "FetchPriority" "auto"
  )
  (dict
    "Match"  "enhanced"
    "FetchPriority" "low"
  )
  (dict
    "Match" "optional"
    "FetchPriority" "low"
  )
) }}

{{ range $target := $targets }}
  {{ $mediaType := default "all" $target.Media }}
  {{ if (in $mediaTypeList $mediaType) }}

    {{ $targetPriorityBundles := slice }}
    {{ range $priority := $priorities }}
      {{ $targetPriorityParams := (dict
          "AssetVariant" $assetVariant
          "MediaType" $mediaType
          "TargetName" $target.Target
          "PriorityMatch" $priority.Match
      ) }}

      {{ if $debug }}
        {{ warnf "%s .Target=%v targetPriorityParams=%v" $dbg $target.Target }}
      {{ end }}

      {{/* Get the target priority bundle */}}
      {{ with $targetPriorityBundle := partial "claris/_functions/scripts/target-priority-bundle" $targetPriorityParams }}
        {{ $scriptBundle := (dict
              "media" $mediaType
              "resource" $targetPriorityBundle
              "fetchpriority" $priority.FetchPriority
            ) }}
        {{ $targetPriorityBundles = append $scriptBundle $targetPriorityBundles }}
        {{ if $debug }}
          {{ warnf "%s .Target=%v: Generated target priority bundle with targetPriorityParams:\n%v"
              $dbg $target.Target (jsonify (dict "indent" "  ") $targetPriorityParams) }}
        {{ end }}
      {{ else }}
        {{ if $debug }}
          {{ warnf "%s .Target=%v: No target priority bundle from targetPriorityParams:\n%v" $dbg $target.Target (jsonify (dict "indent" "  ") $targetPriorityParams) }}
        {{ end }}
      {{ end }}

    {{ end }}

    {{ $scriptBundles = merge $scriptBundles (dict $target.Target $targetPriorityBundles)}}

  {{ else }}
    {{ if $debug }}
      {{ warnf "%s Not generating script bundle for MediaType=%s: not in MediaTypeList=%v"
          $dbg $mediaType $mediaTypeList }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $debug }}
  {{ warnf "%s returning scriptBundles: %s" $dbg
      (jsonify (dict "indent" "  ") $scriptBundles) }}
{{ end }}
{{ return $scriptBundles }}
