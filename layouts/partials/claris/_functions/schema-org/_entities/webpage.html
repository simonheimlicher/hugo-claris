{{ $schemaOrgEntities := .Entities }}
{{ $entityParams := .}}
{{ $page := .Page }}
{{ $meta := page.Scratch.Get "clarismeta" }}
{{ $template := "claris/_functions/schema-org/_entities/webpage" }}
{{ $debug := and false (or .Debug ($page.Param "clarisdebug") ) }}
{{ $dbg := printf "%s[%s->%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) .Template (replaceRE `.*?([^/]+)$` `$1` $template) }}

{{ $dateFormat := default "2006-01-02T15:04:05.00Z" .Format.Date }}

{{ $entityParams := merge . (dict "Debug" $debug) }}

<!-- [Schema.org entity Article](https://schema.org/Article)
-->

{{ $webPageEntity := dict }}
{{ $webPageData := dict "@type" "WebPage" }}

{{ with $schemaOrgEntities }}
  {{ $webPageData = merge $webPageData (dict
      "author" .PageAuthor.Reference
      "creator" .PageAuthor.Reference
      "accountablePerson" .PageAuthor.Reference
      "copyrightHolder" .PageAuthor.Reference
      "publisher"  .SiteAuthor.Reference
  ) }}
  {{ if $debug }}
    {{ warnf "%s added author data to webPageData:\n%v" $dbg (jsonify (dict "indent" "  ") $webPageData) }}
  {{ end }}
{{ else }}
  {{ errorf "%s Missing parameter .Entities" $dbg }}
{{ end }}

{{ with $meta.Single.Data }}
  {{ $webPageData = merge $webPageData (dict
      "@type" "WebPage"
      "@id" .EntityID
      "name" .Title
      "headline" .Headline
      "description" (default $meta.Site.Data.Description .Description)
      "inLanguage" .Language
      "isFamilyFriendly" "true"
      "copyrightYear" .CopyrightYear
      "dateCreated" (.Date.Created.Format $dateFormat | safeHTML)
      "dateModified" (.Date.Modified.Format $dateFormat | safeHTML)
      "url" .CanonicalURL
      "genre" (default .Genre .ArticleSection)
      "keywords" .Keywords
  ) }}
  {{ if and .Date.Created .Date.Published (ne .Date.Published .Date.Created) }}
    {{ $webPageData = merge $webPageData (dict
        "datePublished" (.Date.Published.Format $dateFormat | safeHTML)
    ) }}
  {{ end }}

  {{ with $shareImageURLs := partial "claris/_functions/meta/images/get-image" (dict
      "Page" $page
      "kind" "share"
      "return" "canonicalurls"
      "Debug" $debug
    ) }}
    {{ $webPageData = merge $webPageData (dict
        "image" $shareImageURLs
      ) }}
  {{ else }}
    {{ if $debug }}
      {{ warnf "%sMissing share image in lang=%v" $dbg site.LanguagePrefix }}
    {{ end }}
  {{ end }}
  {{ if $debug }}
    {{ warnf "%s added .Data.Single to webPageData:\n%v" $dbg (jsonify (dict "indent" "  ") $webPageData) }}
  {{ end }}
{{ else }}
  {{ errorf "%s Missing .Scratch for .Single.Data" $dbg }}
{{ end }}

{{ with $webPageData}}
  {{ $webPageEntity = (dict
      "Entity" $webPageData
      "Reference" (dict "@id" (index $webPageData "@id") )
    ) }}
  {{ $schemaOrgEntities = merge $schemaOrgEntities (dict
    "Entities" (dict "WebPage" $webPageEntity)
  ) }}
{{ else }}
  {{ errorf "%s failed to create WebPage entity" $dbg }}
{{ end }}

{{ if $debug }}
  {{ warnf "%s returning %v" $dbg (jsonify (dict "indent" "  ") $schemaOrgEntities) }}
{{ end }}

{{ return $schemaOrgEntities }}
