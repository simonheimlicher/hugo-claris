{{- $meta := page.Scratch.Get "clarismeta" }}
{{- $template := "partials/claris/main/content/panel" }}
{{- $debug := false }}
{{- /* {{- $debug = page.Scratch.Get "clarisdebug" }} */ -}}
{{- /* {{- $debug = or $debug (not (not (findRE `leadership` page.RelPermalink) ) ) }} */ -}}

{{- $panelRoot := "_index" }}
{{- $panelPageResourceGlob := "*.md" }}
{{- $panelCardResourceGlob := "*/index.md" }}

{{- warnf "%s[%s]: Rendering page resources matching '%v/%v' as panels"
    page $template $panelRoot $panelPageResourceGlob }}

{{ partial "html-comment" (printf "[%s]: BEGIN" $template) }}
<article class="panel_content content_panel content">
{{- with .Content }}
  <div class="article_body inner_horizontal">
  {{- . }}
  </div>
{{- end }}
{{- $panelRootPage := page.GetPage $panelRoot }}
{{- $panelResources := slice }}
{{- with $panelRootPage }}
  {{- with .Resources.Match $panelPageResourceGlob }}
    {{- $panelResources = append . $panelResources }}
  {{- end }}
  {{- with .Resources.Match $panelCardResourceGlob }}
    {{- $panelResources = append . $panelResources }}
  {{- end }}
  {{- warnf "%s[%s]: panelRootPage=%v panelPageResourceGlob=%v panelCardResourceGlob=%v panelResources=%v"
  page $template $panelRootPage $panelPageResourceGlob $panelCardResourceGlob $panelResources }}
  {{- with $panelResources }}
    {{- $panelResources = sort . ".Params.weight" }}
  {{- else }}
    {{- if $debug }}
      {{- warnf "%s[%s]: No page resources match panelPageResourceGlob=%v panelCardResourceGlob=%v: panelResources=%v"
          page $template $panelPageResourceGlob $panelCardResourceGlob $panelResources }}
    {{- end }}
  {{- end }}
{{- else }}
  {{- if $debug }}
    {{- warnf "%s[%s]: page.GetPage %v failed"
        page $template $panelRoot }}
  {{- end }}
{{- end }}

{{- with $panelResources }}
  <div class="panel_container">
  {{- range $panelID, $panelPage := $panelResources }}
    {{- $panelStyle := default false .Params.inlinestyle }}
    {{- with $panelStyle }}
      {{- $panelStyle = printf ` style="%v"` . | safeHTMLAttr }}
    {{- end }}
    <section class="panel_item panel_item-{{ $panelID }}"{{ with $panelStyle }}{{ . }}{{ end }}>
    {{- with .Title }}
      <h2 class="panel_title">{{ page.RenderString . }}</h2>
    {{- end }}
    {{ .Content }}
    {{- $panelPageName := .Name }}
    {{- $cardResourceGlob := printf "%v/*.md" (path.Dir $panelPageName) }}
    {{- $cardPages := $panelRootPage.Resources.Match $cardResourceGlob }}
    {{- with $cardPages }}
      <div class="card_container">
      {{- $cardPages = sort (where $cardPages "Name" "ne" $panelPageName) ".Params.weight" }}
      {{- range $cardID, $cardPage := $cardPages }}
        {{- $cardStyle := default false .Params.inlinestyle }}
        {{- with $cardStyle }}
          {{- $cardStyle = printf ` style="%v"` . | safeHTMLAttr }}
        {{- end }}
        <div class="card_item"{{ with $cardStyle }}{{ . }}{{ end }}>
        {{- with .Title }}
          <h3 class="card_title">{{ page.RenderString . }}</h2>
        {{- end }}
        {{- with .Params.image.excerpt.resource }}
          {{- partial "responsive-image" (dict
            "Page" page
            "resource" .
            "float" "left"
            "fetchpriority" (cond (eq $cardID 0) "high" "auto")
            "relativewidth" 20) }}
        {{- end }}
        {{ .Content }}
        </div>
      {{- end }}
      </div>
    {{- else }}
      {{- if $debug }}
        {{- warnf "%s[%s]: panelPage=%v: no page resources matching %v"
            page $template $panelPage $cardResourceGlob }}
      {{- end }}
    {{- end }}
    </section>
  {{- end }}
  </div>
{{- end }}
{{- partial "claris/_components/i18nlist" . }}
</article>
{{ partial "html-comment" (printf "[%s]: END" $template) }}
