{{- $template := "partials/render-meta-images" }}
{{- $page := default page .Page }}
{{- $meta := page.Scratch.Get "clarismeta" }}
{{- $debug := and false (or .Debug ($page.Param "clarisdebug") ) }}
{{- $dbg := printf "%s[%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) (replaceRE `.*?([^/]+)$` `$1` $template) }}
{{- $renderImageArgs := partial "claris/_functions/resources/images/parse-image-args" (merge . (dict "Page" $page) ) -}}
{{- $renderImageArgs = merge $renderImageArgs (dict
  "Debug" $debug
) -}}

{{- $kindParam := .kind -}}
{{- $variantParam := .variant -}}
{{- $versionParam := .version -}}

{{- /* The attribute 'sizes' is mandatory when specifying a 'srcset' attribute */ -}}
{{- $defaultSizes := "100vw" }}
{{- $defaultPosition := "center center" }}
{{- $defaultMedia := "default" }}
{{- $defaultVariantName := "default" }}

{{- $variantSrcSetArgs := $renderImageArgs }}

{{- $imageMeta := dict }}
{{- with $meta.Single.Data.Images }}
  {{- $imageMeta = . }}
{{- else }}
  {{- $metaImagesParams := (dict
    "Params" $page.Params
    "Debug" false
  ) }}
  {{- $imageMeta = partialCached "claris/_functions/meta/images/from-params" (merge $metaImagesParams (dict "Page" $page) ) $metaImagesParams }}
{{- end }}

{{- if and false $debug }}
  {{- warnf "%s Processing imageMeta:\n%v" $dbg (jsonify (dict "indent" "  ") $imageMeta) }}
{{- end }}

{{- if $kindParam }}
  {{- with index $imageMeta $kindParam }}
    {{- $imageMeta = (dict $kindParam . ) }}
  {{- end }}
  {{- if $debug }}
    {{- warnf "%s use only .kind=%v of imageMeta:\n%v" $dbg $kindParam (jsonify (dict "indent" "  ") $imageMeta) -}}
  {{- end }}
{{- end }}

{{- $classPrefix := "render-image_" }}
{{- $pictureResources := slice -}}
{{- range $kindName, $kindMeta := $imageMeta }}

  {{- if $debug }}
    {{- warnf "%s Processing kind=%v with .variant:\n%v" $dbg
        $kindName (jsonify (dict "indent" "  ") $kindMeta.variant) }}
  {{- end }}

  {{- $imageMetaKind := .variant }}

  {{- if $variantParam }}
    {{- with index $imageMetaKind $variantParam }}
      {{- $imageMetaKind = (dict $variantParam . ) }}
    {{- end }}
    {{- if $debug }}
      {{- warnf "%s use only .variant=%v of imageMetaKind:\n%v" $dbg $variantParam (jsonify (dict "indent" "  ") $imageMetaKind) -}}
    {{- end }}
  {{- end }}

  {{- range $variantName, $variantMeta := $imageMetaKind }}

    {{- if $debug }}
      {{- warnf "%s Processing variant=%v with .version:\n%v" $dbg
          $variantName (jsonify (dict "indent" "  ") $variantMeta.version) }}
    {{- end }}

    {{- $resMedia := .media }}
    {{- $imgTitle := .title }}
    {{- $imgSizes := default $defaultSizes .sizes }}
    {{- $imgPosition := default $defaultPosition .position }}
    {{- $imgClass := printf "%simg" $classPrefix }}
    {{- $variantStyleAttr := printf "object-fit: cover; object-position: %s" $imgPosition }}

    {{- $imgAlt := .alt | default $imgTitle | default (path.BaseName .resource | humanize | strings.FirstUpper) }}
    {{- $imgCredit := .credit }}

    {{- $variantImgArgs := (dict
          "class" $imgClass
          "media" $resMedia
          "style" $variantStyleAttr
          "sizes" $imgSizes
          "position" $imgPosition
          "title" $imgTitle
          "alt" $imgAlt
          "credit" $imgCredit
    ) }}

    {{- $imageMetaKindVariant := .version }}

    {{- if $versionParam }}
      {{- with index $imageMetaKindVariant $versionParam }}
        {{- $imageMetaKindVariant = (dict $versionParam . ) }}
      {{- end }}
      {{- if $debug }}
        {{- warnf "%s use only .version=%v of imageMetaKindVariant:\n%v" $dbg $versionParam (jsonify (dict "indent" "  ") $imageMetaKindVariant) -}}
      {{- end }}
    {{- end }}

    {{- $variantFormats := slice }}
    {{- $variantPlaceholder := false }}
    {{- range $versionName, $versionMeta := $imageMetaKindVariant }}

      {{- $versionSrcSetArgs := merge $variantSrcSetArgs $versionMeta }}

      {{- if $debug }}
        {{- warnf "%s Processing version=%v with versionMeta:\n%v" $dbg
            $versionName (jsonify (dict "indent" "  ") $versionMeta) }}
      {{- end }}

      {{- with partialCached "claris/_functions/resources/images/image-srcset"
            $versionSrcSetArgs (merge $versionSrcSetArgs (dict "Page" nil) ) }}
        {{- $variantFormats = append $variantFormats .formats }}
        {{- $variantPlaceholder = .placeholder }}
      {{- else }}
        {{- warnf "%s failed to get srcSet with %v" $dbg $versionSrcSetArgs -}}
      {{- end }}
    {{- end }}

    {{- $variantFormatSrcSets := (dict
      "formats" $variantFormats
      "placeholder" $variantPlaceholder
    ) }}
    {{- $pictureResources = append $pictureResources (slice (dict
      "variant" $variantName
      "imgargs" $variantImgArgs
      "formatsrcsets" $variantFormatSrcSets
    ) ) }}

  {{- end }}
{{- end }}

{{- with $pictureResources }}
  {{- if $debug }}
    {{- warnf "%s Rendering pictureResources:\n%v"
        $dbg (jsonify (dict "indent" "  ") . ) }}
  {{- end }}
  {{- $defaultSrcURL := "" }}
  {{- with (where $pictureResources "variant" "eq" $defaultVariantName) }}
    {{- with last 1 (index . 0).formatsrcsets.formats }}
      {{- $defaultSrcURL = (index . 0).resource.RelPermalink }}
    {{- end }}
  {{- end }}
  {{- if not $defaultSrcURL }}
    {{- warnf "%s Failed to determine defaultSrcURL from %v"
        $dbg (jsonify (dict "indent" "  ") . ) -}}
  {{- end }}

  {{- $pictureClass := printf "%spicture" $classPrefix }}

  <!-- HTML element `picture` is a grouping element and must not contain any styles -->
  <picture{{ with $pictureClass }} class="{{ safeHTMLAttr . }}"{{ end }}>

  {{- $multiVariant := false }}
  {{- range $variant := where $pictureResources "variant" "ne" $defaultVariantName }}
    {{- $pictureArgs := merge .imgargs (dict "placeholder" .formatsrcsets.placeholder) }}
    {{- $multiVariant = true }}
    {{- if $debug }}
      {{- warnf "%s media=%v: pictureResource=%v"
          $dbg .media (jsonify (dict "indent" "  ") . ) }}
    {{- end }}
    {{- range .formatsrcsets.formats }}
      {{- partial "claris/_components/render-picture-sources" (merge $pictureArgs (dict "formats" . ) ) }}
    {{- end }}
  {{- end }}

  {{- range $variant := where $pictureResources "variant" "eq" $defaultVariantName }}
    {{- $pictureArgs := merge .imgargs (dict "placeholder" .formatsrcsets.placeholder) }}
    {{- $numFormats := len .formatsrcsets.formats }}
    {{- if gt $numFormats 1 }}
      {{- $nonDefaultFormats := first (sub $numFormats 1) .formatsrcsets.formats }}
      {{- if $debug }}
        {{- warnf "%s media=%v: nonDefaultFormats=%v"
            $dbg .media (jsonify (dict "indent" "  ") $nonDefaultFormats ) }}
      {{- end }}
      {{- partial "claris/_components/render-picture-sources" (merge $pictureArgs (dict "formats" $nonDefaultFormats ) ) }}
    {{- end }}

    {{- range (last 1 .formatsrcsets.formats) }}
      {{- partial "claris/_components/render-img" (merge $pictureArgs . ) }}
    {{- end }}
  {{- end }}
  </picture>

{{- end }}
