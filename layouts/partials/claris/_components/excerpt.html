{{- $page := .Page }}
{{- $excerptMeta := .Meta }}
{{- $template := "claris/_components/excerpt" }}

{{- $scratchExcerptRenderedKey := "claris.page.excerpt-rendered" }}
{{- if not ($page.Scratch.Get $scratchExcerptRenderedKey) }}
  {{- $page.Scratch.Add $scratchExcerptRenderedKey slice }}
{{- end }}

{{- $excerptImageKey := default "excerpt.variant.default.version.default" .ExcerptImageKey }}

{{- $subjectPage := .SubjectPage }}
{{- $title := default "" .Title }}
{{- $showContent := default true .ShowContent }}
{{- $showDate := default true .ShowDate }}
{{- $relativeDates := default true .RelativeDates }}
{{- $showTags := default false .ShowTags }}
{{- $showAuthor := default false .ShowAuthor }}
{{- $showAuthorLink := default false .AuthorLink }}
{{- $showAuthorAvatar := default false .AuthorAvatar }}
{{- $headerPartial := default "" .HeaderPartial }}
{{- $itemType := default "page" .ItemType }}
{{- $headingLevel := default 3 .HeadingLevel }}
{{- $containerFloat := default false .ContainerFloat }}
{{- $containerRelativeWidth := default false .ContainerRelativeWidth }}
{{- $fetchPriority := default false .FetchPriority }}

{{- $debug := false }}
{{- /* {{- $debug = page.Scratch.Get "clarisdebug" }} */ -}}
{{- /* {{- $debug = or $debug (not (not (findRE `^(/[^/]+-demo/)?/leadership/` $page.RelPermalink) ) ) -}} */ -}}
{{- /* {{- $debug = or $debug (eq $page.Kind "home") -}} */ -}}

{{- $excerptContent := false }}
{{- if not $excerptMeta }}
  {{- $excerptMeta = partial "claris/_functions/meta/single" (dict "Page" $subjectPage) }}
{{- end }}

{{- if $debug }}
  {{- warnf "%s[%s]: .SubjectPage=%v[%T] $excerptMeta.Single.Page=%v" $page $template $subjectPage $subjectPage $excerptMeta.Single.Page }}
{{- end }}

{{- $containerClassList := slice "excerpt_container" }}
{{ if $page.Param "featured" }}
  {{- $containerClassList = append "featured" $containerClassList }}
{{- end }}

{{- with $containerFloat }}
  {{- $containerClassList = append (printf "float-%s" .) $containerClassList -}}
{{- end -}}

{{- with $containerRelativeWidth }}
  {{- $containerClassList = append (printf "relative-width-%d" (int .)) $containerClassList -}}
{{- end -}}

{{- if (eq $itemType "article") }}
  {{- $headerPartial = default "claris/_components/meta" .HeaderPartial  }}
{{- end }}

{{- if not (in ($page.Scratch.Get $scratchExcerptRenderedKey) $subjectPage) }}
  {{- if $debug }}
    {{- warnf "%s[%s]: %s is not in excerpts rendered=[%v]" $page $template $subjectPage (delimit ($page.Scratch.Get $scratchExcerptRenderedKey) ", ") }}
  {{- end }}

  {{- with $subjectPage }}
    {{- $excerptImage := false }}
    {{- $imageMeta := $excerptMeta.Single.Data.Images }}
    {{- if not $imageMeta }}
      {{- with $excerptMeta.List }}
        {{- $imageMeta = .Data.Images }}
      {{- end }}
    {{- end }}
    {{- /* {{- if $debug }}
      {{- warnf "%s[%s]: imageMeta=%v"
          $subjectPage $template
          (jsonify (dict "indent" "  ") $imageMeta) }}
    {{- end }} */ -}}
    {{- with $imageMeta }}
      {{- with (index . (split $excerptImageKey ".")) }}
        {{- $excerptImage = .resource }}
        {{- if $debug }}
          {{- with $excerptImage }}
            {{- warnf "%s[%s]: %s has excerptImage=%v"
                $page $template $subjectPage $excerptImage -}}
          {{- else }}
            {{- warnf "%s[%s]: %s: no key '%s' in imageResources=%v"
                $page $template $subjectPage $excerptImageKey (jsonify (dict "indent" "  ") .) -}}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- if $showContent }}
      {{- range (slice .Params.excerpt .Summary .Params.description .Params.summary) }}
        {{- with . }}
          {{- $excerptContent = . }}
        {{- end }}
      {{- end }}
      {{- $excerptContent = $excerptContent | partial `claris/_functions/sanitize` }}
    {{- end }}
    {{- $excerptTitle := default (default .Title $excerptMeta.Single.Data.Title) $title }}
    {{- $plainTitle := partial `claris/_functions/sanitize` $excerptTitle }}
    <div class="{{ delimit $containerClassList " " }}">
      <a href="{{ .Permalink }}" title="{{ $plainTitle }}">
        <div class="excerpt_header">
          <h{{ $headingLevel }} class="excerpt_title">
          {{ $excerptTitle | $page.RenderString }}
          </h{{ $headingLevel }}>
          {{- with $headerPartial }}
            {{ partial $headerPartial (dict
              "Page" $page
              "SubjectPage" $subjectPage
              "ContainerClass" "excerpt_meta"
              "ShowAuthor" $showAuthor
              "AuthorAvatar" $showAuthorAvatar
              "AuthorLink" $showAuthorLink
              "ShowDate" $showDate
              "RelativeDates" $relativeDates
              "ShowTags" $showTags) }}
          {{- end }}
        </div>
        <div class="excerpt_main{{ if $excerptImage }} image{{ end }}{{ if $excerptContent }} content{{ end }}">
          {{- with $excerptImage }}
            {{- if not $fetchPriority }}
              {{- if lt ($page.Scratch.Get "claris.image.prioritized") 1 }}
                {{- $page.Scratch.Add "claris.image.prioritized" 1 }}
                {{- $fetchPriority = "high" }}
                {{- if $debug }}
                  {{- warnf "%s[%s]: claris.image.prioritized incremented to %d. Prioritizing excerpt image for %v"
                      $page $template ($page.Scratch.Get "claris.image.prioritized") $subjectPage -}}
                {{- end }}
              {{- else }}
                {{- if $debug }}
                  {{- warnf "%s[%s]: claris.image.prioritized already at %d. Not prioritizing excerpt image for %v"
                      $page $template ($page.Scratch.Get "claris.image.prioritized") $subjectPage -}}
                {{- end }}
              {{- end }}
            {{- end }}
            <div class="excerpt_thumbnail">
                {{ partial "responsive-image" (dict
                  "Page" $page
                  "resource" .
                  "title" $plainTitle
                  "alt" (default $plainTitle $imageMeta.excerpt.variant.default.alt)
                  "fetchpriority" $fetchPriority
                  "quality" "low"
                ) }}
            </div>
          {{- end }}
          {{- with $excerptContent }}
          <div class="excerpt_content">
            {{- page.RenderString . -}}
          </div>
          {{- end }}
        </div>
        <div class="excerpt_footer">
          {{- $pageCount := 0 }}
          {{- /* {{- if $debug }}
            {{- warnf "%s[%s]: Items in excerpt: %v" $subjectPage $template $excerptMeta.List }}
          {{- end }} */ -}}
          {{- with $excerptMeta.List }}
            {{- $pageCount = len .Data.Items }}
          {{- end }}
          <div class="excerpt_footer_read-on">
            <span class="read-on">{{- T "read_on" }}</span>
          </div>
          {{- if (gt $pageCount 0) }}
          <div class="excerpt_footer_page-count">
          {{ $pageCount }} {{ T "articles" $pageCount }}
          </div>
          {{- end }}
        </div>
      </a>
    </div>
    {{ $page.Scratch.Add $scratchExcerptRenderedKey $subjectPage }}
  {{- end }}
{{- end -}}
