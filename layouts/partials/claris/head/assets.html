{{- $page := .Page }}
{{- $template := "claris/head/assets" }}
{{- $debug := false }}
{{- /* {{- $debug = page.Scratch.Get "clarisdebug" }} */ -}}
{{/* {{- $debug = or $debug (in (slice "home" "section" "page") $page.Kind) }} */}}

{{- $assetVariant := $page.Scratch.Get "claris.assets.variant" -}}
{{- $bundleParams := $assetVariant.BundleParams  }}

{{- $assets := partialCached "claris/_functions/asset-bundles" . $assetVariant -}}

{{- $scriptBundles := $assets.Scripts }}
{{- $styleBundles := $assets.Styles }}

{{- range $styleBundleID := (slice "main_all") }}
  {{- $styleSheet := (index $styleBundles $styleBundleID) }}
  {{- with $styleSheet }}
    {{- $preloadFonts := partialCached "claris/_functions/resources/fonts/preload" (dict "Page" $page "StyleSheet" .) $assetVariant }}
    {{- if $debug }}
      {{- warnf "%s[%s]: .Kind=%v: Pre-loading font .Scratch claris.assets.font.main=%v %v"
          $page $template $page.Kind ($page.Scratch.Get "claris.assets.font.main") $preloadFonts }}
    {{- end }}
    {{- range first 2 $preloadFonts }}
    <link rel="preload" href="{{ .URL | safeHTMLAttr }}" as="font" type="font/{{ .Type | safeHTMLAttr }}" crossorigin="anonymous">
    {{- end }}
    {{- if not (strings.HasSuffix $styleBundleID "print") }}
    <link rel="preload" href="{{ .resource.Permalink }}" as="style" integrity="{{ .resource.Data.Integrity }}" crossorigin="anonymous">
    {{- end }}
    <link rel="stylesheet" id="style_claris_main" type="text/css" media="{{ .media }}" href="{{ .resource.Permalink }}" {{- with .fetchpriority }} fetchpriority="{{ . }}"{{ end }} integrity="{{ .resource.Data.Integrity }}" crossorigin="anonymous">
  {{- else }}
    {{- errorf "Render %s[%s]: missing stylesheet '%s' [onlyMediaType=%s]" $page $template $styleBundleID $bundleParams.OnlyMediaType }}
  {{- end }}
{{- end }}

{{- with $scriptBundles.head_async }}
    <script type="module" async src="{{ .resource.Permalink }}" integrity="{{ .resource.Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}
{{- with $scriptBundles.head }}
    <script type="module" src="{{ .resource.Permalink }}" integrity="{{ .resource.Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}
{{- with $scriptBundles.head_legacy }}
    <script nomodule src="{{ .resource.Permalink }}" integrity="{{ .resource.Data.Integrity }}" crossorigin="anonymous"></script>
{{- end }}

{{- partialCached "claris/head/fonts" . $assetVariant }}

{{- /*<!-- Include CSS for browsers that lack support for CSS properties and CSS grid statements, generated by PostCSS plugin autoprefixer -->*/ -}}
{{- /* warnf "%s[%s]: SupportIE11=%v: bundleParams=%v" $page $template $bundleParams.SupportIE11 $bundleParams */ -}}
{{- if $bundleParams.SupportIE11 }}
  {{- $legacyStyleBundleID := printf "main_%s%s" $bundleParams.LegacyMediaType $bundleParams.LegacySuffix }}
  {{- $legacyStyleSheet := index $styleBundles $legacyStyleBundleID }}
  {{- with $legacyStyleSheet }}
    <script>
      if (!(window.CSS && (CSS.supports('color', 'var(--CSS-property-support-validation)') && CSS.supports('display', 'grid')))) {
        let e = document.createElement('link'); e.rel = 'stylesheet'; e.media = '{{ .media }}'; e.href = {{ printf "'%v'" .resource.Permalink | safeJS }}; e.integrity = {{ printf "'%v'" .resource.Data.Integrity | safeJS }}; e.crossOrigin = 'anonymous';
        let o = document.getElementById('style_claris_main'); o.parentNode.replaceChild(e, o);
      }
    </script>
  {{- else }}
    {{- errorf "%s[%s]: missing stylesheet '%v' [assetVariant=%v]" $page $template $legacyStyleBundleID $assetVariant }}
  {{- end }}
{{- /* {{- else }}
  {{- warnf "%s: $bundleParams.SupportIE11=%v: not adding legacy stylesheet" $template $bundleParams.SupportIE11 -}} */ -}}
{{- end -}}

{{- with ($page.Param "customCSS") }}
  {{- range . -}}
    <link rel="stylesheet" type="text/css" href="{{ relURL . }}">
  {{- end }}
{{- end -}}
