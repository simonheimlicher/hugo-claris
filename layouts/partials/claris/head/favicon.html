{{- $page := default page .Page }}
{{- $template := "claris/head/favicon" }}
{{- $debug := and false ($page.Param "clarisdebug") }}
{{- $dbg := printf "%s[%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) (replaceRE `.*?([^/]+)$` `$1` $template) }}

{{- /* Based on [How to Favicon in 2025: Three files that fit most needs](
https://evilmartians.com/chronicles/how-to-favicon-in-2021-six-files-that-fit-most-needs) */ -}}

{{- $staticDir := "static" }}

{{- $faviconPathPrefix := "site-meta" }}
{{- with page.Param "meta.favicon.pathprefix" }}
  {{- $faviconPathPrefix = . | strings.TrimLeft "/" | strings.TrimRight "/" | relURL }}
  {{- if $debug }}
    {{- warnf `%s page.Param "meta.favicon.pathprefix"='%v' faviconPathPrefix='%v'` $dbg (page.Param "meta.favicon.pathprefix") $faviconPathPrefix }}
  {{- end }}
{{- end }}

{{- /* Generate the PWA manifest based on `static/site.webmanifest`
or generate it based on site metadata that is also used for schema.org (LD+JSON) */ -}}
{{- $manifest := false }}
{{- $staticManifestPath := printf "%s/site.webmanifest" $staticDir }}
{{- $manifestPath := printf "%s/%s" $faviconPathPrefix "site.webmanifest" }}

{{- if fileExists $staticManifestPath }}
  {{- $manifest = resources.FromString $manifestPath (readFile $staticManifestPath) | fingerprint }}
  {{- if $debug }}
    {{- warnf "%s Using static manifest from '%s' .RelPermalink=%s .Integrity=%s .Content:\n%s"
        $dbg $staticManifestPath $manifest.RelPermalink $manifest.Data.Integrity $manifest.Content }}
  {{- end }}
{{- else  }}
  {{- with $manifestData := partial "claris/_functions/app/webmanifest" . }}
    {{- if $debug }}
      {{- warnf "%s generating site.webmanifest at manifestPath=%s with manifestData:\n%v" $dbg
          $manifestPath (jsonify (dict "indent" "  ") $manifestData) }}
    {{- end }}
    {{- $manifestContent := (jsonify (dict "indent" "  ") . ) }}
    {{- with $manifestResource := resources.FromString $manifestPath $manifestContent | fingerprint }}
      {{- $manifest = . }}
      {{- if $debug }}
        {{- warnf "%s Using generated manifest with .RelPermalink=%s .Integrity=%s .Content:\n%s"
            $dbg $manifest.RelPermalink $manifest.Data.Integrity $manifest.Content }}
      {{- end }}
    {{- else }}
      {{- errorf "%s Failed to generate manifest with manifestData:\n%v"
          $dbg (jsonify (dict "indent" "  ") $manifestData) }}
    {{- end }}
  {{- else }}
    {{- errorf "%s Failed to generate manifest" $dbg  }}
  {{- end }}
{{- end }}

{{- $siteIcons := slice }}
{{- $siteIconFallbackSizes := slice 16 32 }}
{{- $siteIconFallbackFormat := "png" }}
{{- $siteIconParams := (dict
  "pathprefix" $faviconPathPrefix
  "match" "*logo*"
  "formats" (slice "svg" "png")
) }}
{{- with $siteIcon := partial "claris/_functions/resources/images/get-icon-resource" $siteIconParams $siteIconParams }}
  {{- $siteIcons = append . $siteIcons }}
  {{- if $debug }}
    {{- warnf "%s added site icon %v to siteIcons=%v" $dbg . $siteIcons }}
  {{- end }}
  {{- $siteIconFallbackParams := merge $siteIconParams (dict
    "formats" (slice "png")
) }}
  {{- with $siteIconFallback := partial "claris/_functions/resources/images/get-icon-resource" $siteIconFallbackParams $siteIconFallbackParams }}
    {{- $resizeParams := (dict
        "resource" $siteIconFallback
        "format" $siteIconFallbackFormat
    ) }}
    {{- range $siteIconFallbackSizes }}
      {{- with partial "claris/_functions/resources/images/get-process-image" (merge $resizeParams (dict "width" . ) ) }}
        {{- if $debug }}
          {{- warnf "%s added site icon %v to siteIcons=%v" $dbg . $siteIcons }}
        {{- end }}
        {{- $siteIcons = append . $siteIcons }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- $appleTouchIcons := slice }}
{{- $appleTouchIconParams := (dict
  "pathprefix" $faviconPathPrefix
  "match" "apple*touch*"
  "formats" (slice "svg" "png")
) }}
{{- with partial "claris/_functions/resources/images/get-icon-resource" $appleTouchIconParams $appleTouchIconParams }}
  {{- $appleTouchIcons = append . $appleTouchIcons }}
  {{- if $debug }}
    {{- warnf "%s added Apple touch icon %v to appleTouchIcons=%v" $dbg . $appleTouchIcons }}
  {{- end }}
{{- end }}

{{- range $siteIcons }}
  {{- $iconSizes := false }}
  {{- if ne .MediaType.Type "image/svg+xml" }}
    {{- $iconSizes = printf "%vx%v" .Width .Height }}
  {{- end }}
    <link rel="icon"{{ with .MediaType.Type }}{{ printf ` type=%q` . | safeHTMLAttr }}{{ end }}{{ with $iconSizes }}{{ printf ` sizes=%q` . | safeHTMLAttr }}{{ end }} href="{{ .RelPermalink }}">
{{- end }}
{{- range $appleTouchIcons }}
    <link rel="apple-touch-icon" type="{{ .MediaType.Type }}" sizes="{{ .Width }}x{{ .Height }}" href="{{ .RelPermalink }}">
{{- end }}
{{- with $manifest }}
    <link rel="manifest" type="application/manifest+json" href="{{ .RelPermalink }}">
{{- end -}}
