{{- $template := "partials/responsive-image" }}
{{- $page := .Page }}
{{- $debug := false }}
{{- /* {{- $debug = page.Scratch.Get "clarisdebug" }} */ -}}
{{/* {{- $debug = or $debug (not (not (findRE `^/([^/]+-demo/)?leadership/$` $page.RelPermalink) ) ) -}} */}}
{{- $imageResourceArgs := merge . (dict
  "Debug" $debug
) -}}

{{- $resourceSpec := .resource -}}
{{- $variantSpec := .variant -}}
{{- $caption := default "" .caption -}}
{{- $imgAlt := default (humanize (path.BaseName $resourceSpec) ) .alt -}}
{{- $imgTitle := default $imgAlt .title -}}
{{- $imgCredit := default false .credit -}}

{{- $imgClass := default "responsive" .imgclass -}}
{{- $defaultPosition := "center center" }}
{{- $imgPosition := default $defaultPosition .position -}}

{{- $defaultSizes := "100vw" }}
{{- $imgSizes := default $defaultSizes .sizes -}}

{{- $figureClass := cond (ne "" $caption) "caption" "" -}}
{{- with .figureclass -}}
  {{- $figureClass = printf "%s %s" $figureClass . -}}
{{- end }}
{{- $containerClass := "" }}

{{- $defaultVersionName := "default" }}

{{- if or (and $resourceSpec (not $imgAlt)) (and $variantSpec (not $variantSpec.default.alt) ) }}
  {{- warnf "%s[%s]: Missing attribute .alt in args=%v"
  $page $template (jsonify (dict "indent" "  ") (merge . (dict "Page" false) ) ) }}
{{- end }}
{{/* {{- warnf "%s[%s]: .resource has type [%T]" $page $template $resourceSpec -}} */}}

{{- with .float -}}
  {{- $containerClass = printf "%s float-%s" $containerClass . -}}
{{- end -}}

{{- with .relativewidth -}}
  {{- $containerClass = printf "%s relative-width-%s" $containerClass . -}}
{{- end -}}

{{- $background := default false .background -}}
{{- with $background }}
  {{- $containerClass = printf "%s background-%s" $containerClass . -}}
{{- end }}

{{- with $containerClass }}
  {{- if $figureClass -}}
    {{- $figureClass = printf "%s %s" (strings.TrimLeft " " $figureClass) . -}}
  {{- else }}
    {{- $imgClass = printf "%s %s" $imgClass . }}
  {{- end }}
{{- end }}

{{- $shape := default false .shape -}}
{{- with $shape }}
  {{- $imgClass = printf "%s shape-%s" $imgClass . }}
{{- end }}

{{ $supportIE11 := default true site.Params.supportIE11 }}

{{- $lightbox := default false .lightbox -}}

{{- $fetchPriority := default "auto" .fetchpriority -}}

{{- $lazy := default (eq $fetchPriority "low") .lazy -}}

{{- $defaultMedia := "default" }}
{{- $defaultVariantName := "default" }}

{{- $targetFormats := default false .targetformats }}
{{- $processingParams := default false .processingparams }}

{{- $imageResourceArgs = merge $imageResourceArgs (dict
  "targetformats" $targetFormats
  "processingparams" $processingParams
) -}}

{{- $figureInlineStyle := "" }}

{{- $imgInlineStyleSlice := slice -}}
{{- range $attr, $value := (dict
  "width" $imageResourceArgs.width
  "height" $imageResourceArgs.height
  "aspect-ratio" $imageResourceArgs.AspectRatio
  "border-radius" $imageResourceArgs.BorderRadius
  "min-width" $imageResourceArgs.MinWidth
  "max-width" $imageResourceArgs.maxwidth
  "min-height" $imageResourceArgs.MinHeight
  "max-height" $imageResourceArgs.maxheight) -}}
  {{- if $value -}}
    {{- $imgInlineStyleSlice = append $imgInlineStyleSlice (slice (printf "%s: %s" $attr $value) ) -}}
  {{- end -}}
{{- end }}
{{- $imgInlineStyle := "" }}
{{- with $imgInlineStyleSlice }}
{{- $imgInlineStyle = delimit $imgInlineStyleSlice "; " -}}
{{- end }}
{{- $imgInlineStyle_attr := "" -}}

{{- with $page }}<!-- Restore "." to refer to page context from which the partial was called -->
  {{- $pictureResources := slice }}
  <!-- Ensure we can use partialCached without accidentally re-using cached versions of the wrong image
  FIXME: Using only a single dictionary as a "cache busting" 2nd argument to `partialCached`
  does not seem sufficient to avoid accidental re-use of image resources.
  In fact, passing both '$imageResourceVariant' and '$imageResourceVariant.resource'
  seems to avoid the issue, but it appears to be clearer to pass the
  resource specification and $imageResourceVariant as two separate arguments -->
  {{- $imageResourceVariant := dict }}
  {{- with $imageResourceArgs }}
    {{- $imageResourceVariant = merge $imageResourceVariant (dict
      "width" .width
      "height" .height
      "targetformats" .targetformats
      "processingparams" .processingparams
    ) }}
  {{- end }}
  {{- if reflect.IsMap $variantSpec }}
    {{- if $debug }}
      {{- warnf "%s[%s]: .variant is map: %v" $page $template $variantSpec -}}
    {{- end }}
    {{- range $variantName, $variantMeta := $variantSpec }}
      {{- $resMedia := .media }}
      {{- $imgTitle = .title }}
      {{- $imgSizes = default $defaultSizes .sizes }}
      {{- $imgPosition = default $defaultPosition .position }}
      {{- $imgAlt = default $imgTitle .alt }}
      {{- $imgCredit = default $imgTitle .credit }}
      {{- $version := default $defaultVersionName .aspect }}
      {{- $res := (index .version $version).resource }}
      {{- $imageResourceArgs = merge $imageResourceArgs (dict "resource" $res ) }}
      {{- with (partialCached "claris/_functions/resources/images/image-srcset" $imageResourceArgs $res $imageResourceVariant) }}
        {{- $pictureResources = append $pictureResources (slice (dict
          "variant" $variantName
          "media" $resMedia
          "sizes" $imgSizes
          "position" $imgPosition
          "formatsrcsets" .
          "title" $imgTitle
          "alt" $imgAlt
          "credit" $imgCredit
        ) ) }}
      {{- else }}
        {{- warnf "%s[%s]: failed to get srcSet with %s" $page $template $imageResourceArgs -}}
      {{- end }}
    {{- end }}
    {{- /* If none of the .media values match $defaultVariantName, take the first image as the default */ -}}
    {{- if (not (where $pictureResources "variant" $defaultVariantName) ) }}
      {{- with (index $variantSpec $defaultVariantName) }}
        {{- $imgTitle = .title }}
        {{- $imgAlt = default $imgTitle .alt }}
        {{- $imgCredit = default $imgTitle .credit }}
        {{- $res := .version.default.resource }}
        {{- $imgPosition = default $defaultPosition .position }}
        {{- $imageResourceArgs = merge $imageResourceArgs (dict "resource" $res ) }}
        {{- with (partialCached "claris/_functions/resources/images/image-srcset" $imageResourceArgs $res $imageResourceVariant) }}
          {{- $pictureResources = append $pictureResources (slice (dict
            "variant" $defaultVariantName
            "media" $defaultMedia
            "position" $imgPosition
            "formatsrcsets" .
            "title" $imgTitle
            "alt" $imgAlt
            "credit" $imgCredit
          ) ) }}
        {{- else }}
          {{- warnf "%s[%s]: failed to get srcSet with %s" $page $template $imageResourceArgs -}}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- else }}
    {{- with (partialCached "claris/_functions/resources/images/image-srcset" $imageResourceArgs $resourceSpec $imageResourceVariant) }}
      {{- $pictureResources = append $pictureResources (slice (dict
          "variant" $defaultVariantName
          "media" $defaultMedia
          "position" $imgPosition
          "formatsrcsets" .
          "title" $imgTitle
          "alt" $imgAlt
          "credit" $imgCredit
        )
      ) }}
    {{- else }}
      {{- warnf "%s[%s]: .resource: %v failed to get srcSet with %s" $page $template $resourceSpec $imageResourceArgs -}}
    {{- end }}
  {{- end }}
  {{/* {{- warnf "%s[%s]: .resource=%q[%T] with imageResourceVariant=%v with imageResourceArgs=%v: pictureResources:\n%v\n"
      $page $template $imageResourceArgs.resource $imageResourceArgs.resource $imageResourceVariant
      $imageResourceArgs $pictureResources -}} */}}

  {{- with $pictureResources }}
    {{- if $debug }}
      {{- warnf "%s[%s]: pictureResources=%v"
          $page $template (jsonify (dict "indent" "  ") . ) }}
    {{- end }}
    {{- $defaultSrcURL := "" }}
    {{- with (where $pictureResources "variant" "eq" $defaultVariantName) }}
      {{- with last 1 (index . 0).formatsrcsets.formats }}
        {{- $defaultSrcURL = (index . 0).resource.RelPermalink }}
      {{- end }}
    {{- end }}
    {{- if not $defaultSrcURL }}
      {{- warnf "%s[%s]: Failed to determine defaultSrcURL from %v"
          $page $template (jsonify (dict "indent" "  ") .) -}}
    {{- end }}
    {{- if $lazy }}
      <noscript>
      {{- if $figureClass }}
        <figure  class="{{ $figureClass }}"
          {{- with $figureInlineStyle -}}
          {{ printf " style=%q" (. | safeCSS) | safeHTMLAttr }}
          {{- end -}}
        >
      {{- end -}}
      {{- if $lightbox -}}
        <a href='{{ $defaultSrcURL }}'>
      {{- end }}
          <picture>
          {{- range $variant := where $pictureResources "variant" "ne" $defaultVariantName }}
            {{- $media := .media }}
            {{- $imgSizes := .sizes }}
            {{- if $debug }}
              {{- warnf "%s[%s]: media=%v: pictureResource=%v"
                  $page $template .media (jsonify (dict "indent" "  ") . ) }}
            {{- end }}
            {{- range .formatsrcsets.formats }}
            <source type="{{ .resource.MediaType }}" media="{{ $media }}" sizes="{{ $imgSizes | safeHTMLAttr }}" srcset="{{ .srcset }}">
            {{- end }}
          {{- end }}
          {{- range $variant := where $pictureResources "variant" "eq" $defaultVariantName }}
            {{- $media := .media }}
            {{- if $supportIE11 }}
              {{ $imgInlineStyle_attr = (printf " style=%q" (printf "object-fit: cover; object-position: %s; font-family: 'object-fit: cover; object-position: %s;'; %s"
                  .position .position $imgInlineStyle | safeCSS)) }}
            {{- else }}
              {{ $imgInlineStyle_attr = (printf " style=%q" (printf "object-fit: cover; object-position: %s; %s"
                  .position $imgInlineStyle | safeCSS)) }}
            {{- end }}
            {{- $numFormats := len .formatsrcsets.formats }}
            {{- if gt $numFormats 1 }}
              {{- $nonDefaultFormats := first (sub $numFormats 1) .formatsrcsets.formats }}
              {{- if $debug }}
                {{- warnf "%s[%s]: variant=%v: nonDefaultFormats=%v"
                    $page $template $variant (jsonify (dict "indent" "  ") $nonDefaultFormats ) }}
              {{- end }}
              {{- range $nonDefaultFormats }}
            <source type="{{ .resource.MediaType }}" sizes="{{ $imgSizes | safeHTMLAttr }}" srcset="{{ .srcset }}">
              {{- end }}
            {{- end }}
            {{- range (last 1 .formatsrcsets.formats) }}
              {{- $srcURL := .resource.RelPermalink }}
              {{- $imgWidth := default .resource.Width $imageResourceArgs.Width }}
              {{- $imgHeight := default .resource.Height $imageResourceArgs.Height }}
            <img class="{{ with $imgClass }}{{ . }}{{ end }}"
                 width="{{ $imgWidth }}" height="{{ $imgHeight }}"
                   src="{{ $srcURL }}"
                srcset="{{ .srcset }}"
                 sizes="{{ $imgSizes | safeHTMLAttr }}"
              {{- with $fetchPriority }}
         fetchpriority="{{ . | safeHTMLAttr }}"
              {{- end }}
              {{- if $lazy }}
               loading="lazy"
              {{- end }}
              {{- with $variant.title }}
                 title="{{ . | safeHTMLAttr }}"
              {{- end }}
              {{- with $variant.alt }}
                   alt="{{ . | safeHTMLAttr }}"
              {{- end }}
              {{- with $imgInlineStyle_attr }}
                {{ $imgInlineStyle_attr | safeHTMLAttr }}
              {{- end -}}
            >
            {{- end }}
          {{- end }}
          </picture>
      {{- if $lightbox -}}
        </a>
      {{- end -}}
      {{- if $figureClass -}}
        {{- with $caption -}}
          <figcaption>
            {{- . | $page.RenderString -}}
          </figcaption>
        {{- end }}
        </figure>
      {{- end }}
      </noscript>
    {{- end }}
    {{- if $figureClass }}
      <figure class="{{ $figureClass }}{{ if $lazy }} lazyload{{ end }}">
      <!-- Would prefer to use NPM module medium-zoom to zoom in on the figure including the caption
      but doing this by adding the following attribute appears not to work: -->
      {{- /* with $lightbox }} data-zoomable="{{ . | safeHTMLAttr }}"{{- end -}} */ -}}
    {{- end }}
        <!-- HTML element is a grouping element and must not contain any styles -->
        <picture>
        {{- range $variant := where $pictureResources "variant" "ne" $defaultVariantName }}
          {{- $media := .media }}
          {{- if $debug }}
            {{- warnf "%s[%s]: media=%v: pictureResource=%v"
                $page $template .media (jsonify (dict "indent" "  ") . ) }}
          {{- end }}
          {{- range .formatsrcsets.formats }}
          <source type="{{ .resource.MediaType }}" media="{{ $media }}" sizes="{{ $imgSizes | safeHTMLAttr }}" srcset="{{ .srcset }}">
          {{- end }}
        {{- end }}
        {{- range $variant := where $pictureResources "variant" "eq" $defaultVariantName }}
          {{- if $supportIE11 }}
            {{ $imgInlineStyle_attr = (printf " style=%q" (printf "object-fit: cover; object-position: %s; font-family: 'object-fit: cover; object-position: %s;'; %s"
                .position .position $imgInlineStyle | safeCSS)) }}
          {{- else }}
            {{ $imgInlineStyle_attr = (printf " style=%q" (printf "object-fit: cover; object-position: %s; %s"
                .position $imgInlineStyle | safeCSS)) }}
          {{- end }}
          {{- $media := .media }}
          {{- $numFormats := len .formatsrcsets.formats }}
          {{- if gt $numFormats 1 }}
            {{- $nonDefaultFormats := first (sub $numFormats 1) .formatsrcsets.formats }}
            {{- if $debug }}
              {{- warnf "%s[%s]: media=%v: nonDefaultFormats=%v"
                  $page $template $media (jsonify (dict "indent" "  ") $nonDefaultFormats ) }}
            {{- end }}
            {{- range $nonDefaultFormats }}
          <source type="{{ .resource.MediaType }}" sizes="{{ $imgSizes | safeHTMLAttr }}" srcset="{{ .srcset }}">
            {{- end }}
          {{- end }}
          {{- $placeholderInlineImg := .formatsrcsets.placeholder }}
          {{- range (last 1 .formatsrcsets.formats) }}
            {{- $srcURL := .resource.RelPermalink }}
            {{- $imgWidth := default .resource.Width $imageResourceArgs.Width }}
            {{- $imgHeight := default .resource.Height $imageResourceArgs.Height }}
          <img  class="{{ with $imgClass }}{{ . }}{{ end }}{{ if $lazy }} lazyload{{ end }}"
                width="{{ $imgWidth }}" height="{{ $imgHeight }}"
            {{- if $lazy }}
                  {{ printf "src=%q" $placeholderInlineImg | safeHTMLAttr }}
               {{ printf "srcset=%q" (printf  "%s %dw" $placeholderInlineImg $imgWidth) | safeHTMLAttr }}
             data-src="{{ $srcURL }}"
          data-srcset="{{ .srcset }}"
              loading="lazy"
            {{- else }}
                  src="{{ $srcURL }}"
               srcset="{{ .srcset }}"
            {{- end }}
            {{- with $fetchPriority }}
        fetchpriority="{{ . | safeHTMLAttr }}"
            {{- end }}
            {{- with $lightbox }}
        data-zoomable="{{ . | safeHTMLAttr }}"
            {{- end }}
                sizes="{{ $imgSizes | safeHTMLAttr }}"
            {{- with $variant.title }}
                title="{{ . | safeHTMLAttr }}"
            {{- end }}
            {{- with $variant.alt }}
                  alt="{{ . | safeHTMLAttr }}"
            {{- end }}
            {{- with $imgInlineStyle_attr }}
              {{ $imgInlineStyle_attr | safeHTMLAttr }}
            {{- end -}}
          >
          {{- end }}
        {{- end }}
        </picture>
    {{- if $figureClass -}}
        {{- with $caption -}}
        <figcaption>
          {{- . | $page.RenderString -}}
        </figcaption>
        {{- end }}
      </figure>
    {{- end }}
  {{- else }}
    {{- warnf "%s[%s]: failed to get srcSet with param .resource=%s" $page $template $resourceSpec -}}
  {{- end }}
{{- end }}
